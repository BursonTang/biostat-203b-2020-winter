---
title: "Biostat 203B Homework 2"
author: Burson Tang UID#305068045
subtitle: Due Feb 7 @ 11:59PM
output: html_document
---

```{r setup, include=FALSE}
# Remember the result of previous run, it will save time.
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)   
```

<!-- # ```{r} -->
<!-- #  -->
<!-- # ``` -->

Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-III](https://mimic.physionet.org) data introduced in [homework 1](https://ucla-biostat203b-2020winter.github.io/hw/hw1/hw1.html).

## Q1

Demographic information of the patients admitted into hospital is available in `ADMISSION.csv`. See <https://mimic.physionet.org/mimictables/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs:   

  - admission year  
- admission month  
- admission week day  
- admission hour  
- length of hospital stay  
- admission type  
- number of admissions per patient  
- admission location  
- insurance  
- language  
- religion  
- martial status  
- ethnicity  
- death 

Note it is possible that one patient (uniquely identified by the `SUBJECT_ID`) is admitted into hospital multiple times. When summarizing some demographic information, it makes sense to summarize based on only unique patients. 

**Solution:**
Load packages and Data:
```{r} 
# load packages
library(tidyverse)
library(dplyr)
library(lubridate)
library(scales)

# Read ADMISSION.csv
Admission <- read_csv('/home/203bdata/mimic-iii/ADMISSIONS.csv',
                 col_types = cols(ROW_ID=col_integer(),
                                  SUBJECT_ID = col_integer(),
                                  HADM_ID = col_integer(),
                                  ADMITTIME = col_datetime(format = ""),
                                  DISCHTIME = col_datetime(format = ""),
                                  DEATHTIME = col_datetime(format = ""),
                                  EDREGTIME = col_datetime(format = ""),
                                  EDOUTTIME = col_datetime(format = "")) )
```

Admission year:

Every year, there are about 550 admission except for the latest years, which has abnormal low admission numbers. It is possible that the latest data has not been updated yet.
```{r}
Admission %>%
  mutate(adm_year = year(ADMITTIME)) %>% # get year components
  ggplot() +
  geom_freqpoly(mapping = aes(x=adm_year,stat(count)),binwidth = 1)+
  # Add more ticks and change xtick label style
  scale_x_continuous(breaks = seq(min(year(Admission$ADMITTIME),na.rm = TRUE),
                               max(year(Admission$ADMITTIME),na.rm = TRUE),5),
                     name = "Admission Year (encrypted)") +
  theme(axis.text.x = element_text(angle = 90))
```

Admission month:

The montly admission is also consistent (around 4750 admissions per month).
```{r}
# 
Admission %>%
  mutate(adm_month = month(ADMITTIME ,label=TRUE)) %>%  # get month components
  ggplot() + geom_bar(mapping = aes(x=adm_month), width=0.5) +
  labs(x="Admission Month")   # add x label

# freqpoly
# Admission %>%
#   mutate(adm_month = month(ADMITTIME)) %>%
#   ggplot() +  geom_freqpoly(mapping = aes(x=adm_month),binwidth = 1) +
#   scale_x_continuous(breaks =seq(1,12,1))

```

Admission week day:

The admission number in weedays is obviously higher than that in the weekend by around 2000.
```{r}
Admission %>%
  # get weekday components
  mutate(adm_weekday = wday(ADMITTIME, label = TRUE)) %>%  
  ggplot() +
  geom_bar(mapping = aes(x=adm_weekday), width = 0.75)+
  labs(x="Admission Weekday")
```

Admission hour:

Admission peak time can be found at 7 a.m.. It is possibel that going to the hospital is the first thing in the morning, or the outpatient service starts from 7 a.m. The admission number drops significantly after the peak and gradually rise to the second peak at 4~5 p.m. before it drops gradually at night.
```{r}
Admission %>% 
  mutate(adm_hr = hour(ADMITTIME)) %>%  # get hour components
  ggplot() +
  geom_bar(mapping = aes(x=adm_hr), width=0.5)+
  # More ticks and x label
  scale_x_continuous(breaks =seq(0,24,1))+
  labs(x= "Amission Hour") 
```

Length of hospital stay (in days):

Most people stay in the hospital less than 30 days, but some people stayed in hospital for as many as 294 days (maximum value).
```{r}
Admission %>%
  # Set unit to days and get the time difference
  mutate(adm_StayTime = as.numeric(difftime(DISCHTIME,ADMITTIME,units = "day"))) %>% 
  ggplot() +
  geom_freqpoly(mapping = aes(x=adm_StayTime),binwidth=1)+
  scale_x_continuous(breaks =seq(0,300,15))+
  labs(x= "Staying Time (day) in Hospital")
```

Admission type:

More than 70%  of people went to this hospital for emergency care. Patients with appointment and newborn babies both count for around 12% admission case, and the left patients came for urgent care.
```{r}
Admission %>%
  ggplot() +
  # plot adimission types as bar chart, with percentage y axis
  geom_bar(mapping = aes(x=ADMISSION_TYPE, y = ..prop.., group = 1),width=0.75)+
  labs(x="Admission Type", y="Percentage")+
  scale_y_continuous(labels = percent)

```


Number of addmissions per patient:

The hospital admitted more than 80% of patients only once, and 10% patients twice. Still, there were patients who got admitted 43 times in this hospital.
```{r}
# by_ID <- group_by(Admission,SUBJECT_ID)
# AdmCounts <- summarise(by_ID, count = n())
# AdmCounts %>%
#   ggplot() +
#   geom_freqpoly(mapping = aes(x=count, stat(density)), binwidth=1)+ 
#   scale_x_continuous(limits = c(0, 10), breaks = seq(0,10,1),
#                      name = 'Adm Times per Patient')

# Use pipe only
Admission %>% 
  group_by(SUBJECT_ID) %>%
  summarise(count = n()) %>%
  ggplot() +
  # plot number of admission per patient as line, with percentage y axis
  geom_freqpoly(mapping = aes(x=count, stat(density)), binwidth=1)+ 
  scale_x_continuous( breaks = seq(0,42,2))+
  scale_y_continuous(labels = percent)+
  labs(y = 'percentage',x = 'Admission # per Patient')
```

Admission location:

Most patients were admitted in the emergency room (almost 40%), followed by pysician referral (25%)
```{r}
Admission %>%
  ggplot() +
  geom_bar(mapping = aes(stringr::str_wrap(ADMISSION_LOCATION,15), y = ..prop.., group = 1) , width=.5) + 
  scale_y_continuous(labels = percent)+
  # the axes are flipped because of the long axis label 
  coord_flip() +
  labs(x = 'Admission Location', y = 'Percentage')

```

*NOTE*: Variables below are uniquely identified by patient/SUBJECTID. Define a variable `by-ID` with unique SUBJECT_ID.
```{r}
by_ID <- distinct(Admission, SUBJECT_ID, .keep_all = TRUE)
```

Insurance:

Most of patients use either medicare (~44%) or private insurance (~42%)
```{r}
by_ID %>%
  ggplot() + 
  geom_bar(mapping=aes(INSURANCE, y = ..prop.., group = 1), width=0.75)+
  scale_y_continuous(labels = percent)+
  labs(x='Insurance Types', y='Percentage')
```

Language:

most language
```{r}
# It is hard to show so many language types on a single plot, try two subplots?
# 
# # New variable for language counts
# Patient_lan <- by_ID %>% 
#   group_by(LANGUAGE) %>%
#   summarise(count=n())
# 
# # plot two subplots on one figure
# # p1 <- ggplot(data = Patient_lan)+
# #   geom_point
library("ggrepel")

by_ID %>%
  # count male or female patients numbers
  group_by(LANGUAGE)  %>%
  summarise(count=n()) %>%
  filter(count>100, !is.na(LANGUAGE)) %>%
  
  # fix the plotting order so I can make label in accordingly
  arrange(desc(LANGUAGE)) %>%
  
  ggplot(aes(x= "", y=count, fill=LANGUAGE)) + 
  geom_bar(width=1, stat = "identity",color = "white")+
  coord_polar(theta = 'y', direction = 1)+
  
  # try label repel
  # geom_label_repel(aes(label = LANGUAGE), data = count)+
  
  # try text repel
  geom_text_repel(aes(y = cumsum(count) - 0.5*count,  # label position
            label = count), size=5)+
  
  # # add percentage labels on the pie charte
  # geom_text(aes(y = cumsum(count) - 0.5*count,  # label position
  #           label = count), size=5) + # label value and size
  
  # get rid of all the axis labels and ticks
  theme_void()+ 
  scale_x_discrete(breaks = NULL)+
  labs(x="",y="")+
  theme(axis.text.x=element_blank(),axis.text.y=element_blank())
  # coord_flip()+
  # labs(x='Language', y='Percentage')

# # Remove nan values?
# by_ID %>%
#   filter(!is.na(LANGUAGE)) %>%
#   ggplot() + 
#   geom_bar(mapping=aes(x=factor(1), fill=LANGUAGE))+
#   coord_polar("y")
# 
# # bar chart?
# by_ID %>%
#   filter(!is.na(LANGUAGE)) %>%  
#   ggplot() + 
#   geom_bar(mapping=aes(LANGUAGE))+
#   coord_flip()+
#   labs(x='Language', y='Percentage')
```

Religion:

About one third patients were Catholics and the religion of around 35% patients were either unobtainable or specified.
```{r}
by_ID %>%
  ggplot() + 
  geom_bar(mapping=aes(RELIGION, y = ..prop.., group = 1))+
  scale_y_continuous(labels = percent)+
  labs(x='Religion', y='Percentage')+
  coord_flip()
```

Martial status:

Around 40% of patients were married. Single patients count for around 21%, and about 12% of them are widowed. Martial stutus data for around 21% patient is not availabel.
```{r}
by_ID %>%
  ggplot() + 
  geom_bar(mapping=aes(MARITAL_STATUS, y = ..prop.., group = 1))+
  labs(x='Maritial Status', y='Percentage')+
  scale_y_continuous(labels = percent)+
  coord_flip()
```


Ethnicity:

Most of the patients in the hospital are white (~69%)
```{r}
by_ID %>%
  group_by(ETHNICITY)  %>%
  summarise(count=n()) %>%
  mutate(Prop = count/sum(count))%>%
  
  # Omit minor Ethnicity (less than 100 patients)
  filter(count>100) %>%
  
  ggplot() + 
  geom_bar(mapping=aes(stringr::str_wrap(ETHNICITY,15), y = Prop),
           stat = "identity", width=0.5)+
  scale_y_continuous(breaks = seq(0,.7,.1),labels = percent)+
  labs(x='Ethnicity', y='Count')+
  coord_flip()
```

Death:

9% of patients die after admitted in the hospital
```{r}
# conditionaly mutate new variable: is.nan(death time) => livy;
# ! is.nan(death time) => dead.
# ifelse can do conditional mutating

by_ID %>% 
  # decide dead or live
  mutate(LifeStatus = ifelse(is.na(DEATHTIME), 'Live','Dead')) %>%
  
  # count dead or live numbers
  group_by(LifeStatus) %>%
  summarise(count=n())%>%
  
  # calculate percentage for label
  mutate(Prop = count/sum(count)) %>%
  
  # fix the plotting order so I can make label in accordingly
  arrange(desc(LifeStatus)) %>%
  
  # Use percentage value as y values, and set stat as identity
  ggplot(aes(x = "", y= Prop, fill= LifeStatus)) +
  
  # separate pie chart segment with white lines
  geom_bar(width = 1, color = "white",stat="identity")+
  coord_polar(theta = 'y', direction = 1)+
  
  # add percentage labels on the pie charte
  geom_text(aes(y = cumsum(Prop) - 0.5*Prop,  # label position
            label = percent(Prop)), size=5)+ # label value and size
  
  # get rid of all the axis labels and ticks
  theme_void()+
  scale_x_discrete(breaks = NULL)+
  labs(x="",y="")+
  theme(axis.text.x=element_blank(),axis.text.y=element_blank())


# by_ID %>%
#   mutate(LifeStatus = ifelse(is.na(DEATHTIME), 'Live','Dead')) %>%
#   ggplot() +
#   geom_bar(mapping=aes(x = factor(1), fill= LifeStatus))+
#   coord_polar(theta = 'y', direction = 1)+
#   scale_x_discrete(breaks = NULL, name = '')+
#   scale_y_discrete(breaks = NULL, name = '')+
#   theme(axis.text.x=element_blank())
```


## Q2

Link the data in `ADMISSION.csv` and `PATIENTS.csv` (<https://mimic.physionet.org/mimictables/patients/>) and summarize following variables using appropriate graphs:  

- gender  
- age at admission 

**Solutions:**

Read data and join two tibble by `SUBJECT_ID`. Only `ADMISSION.csv` has duplicate keys
```{r}
# Read the PATIENTS data
Patients <-read_csv('/home/203bdata/mimic-iii/PATIENTS.csv',
                 col_types = cols(ROW_ID=col_integer(),
                                  SUBJECT_ID = col_integer(),
                                  GENDER = col_character(),
                                  DOB = col_datetime(format = ""),
                                  DOD = col_datetime(format = ""),
                                  DOD_HOSP = col_character(),
                                  DOD_SSN = col_datetime(format = ""),
                                  EXPIRE_FLAG = col_integer() ))

# join two datasets  => Only Admission has duplicate data
JointT <- left_join(Admission, Patients, by = "SUBJECT_ID")
```

Gender:

Male and female patients count 56% and 44% respectively
```{r}
JointT %>%
  # demographic info for unique patients
  distinct(SUBJECT_ID, .keep_all = TRUE) %>%
  
  # count male or female patients numbers
  group_by(GENDER) %>%
  summarise(count=n())%>%
  
  # calculate percentage for label
  mutate(Prop = count/sum(count)) %>%
  
  # fix the plotting order so I can make label in accordingly
  arrange(desc(GENDER)) %>%
  ggplot(aes(x = "", y= Prop, fill= GENDER)) + 
  geom_bar(width=1, stat = "identity",color = "white")+
  coord_polar(theta = 'y', direction = 1)+
  
  # add percentage labels on the pie charte
  geom_text(aes(y = cumsum(Prop) - 0.5*Prop,  # label position
            label = percent(Prop)), size=5)+ # label value and size

  
  # get rid of all the axis labels and ticks
  theme_void()+ 
  scale_x_discrete(breaks = NULL)+
  labs(x="",y="")+
  theme(axis.text.x=element_blank(),axis.text.y=element_blank())

  
```

Admission Age:

*NOTE:* Unrealistic DOB (300 years before the admission) is set for patient who are older than 89 years old (<https://mimic.physionet.org/mimictables/patients/>)
For this hospital, a major group of the "patients" are newborn baby (around 14%, more than 8000). It did not take any patients between 1~16 years old, and its patients' age range from 15~90. It seems it took more senior patients than youger ones.
```{r}
f<- JointT %>%
  # calculate the difference b/t bod & admission time
  mutate(age = difftime(ADMITTIME,DOB, units = "days")/365 ) %>% 
  # get rid of unrealistic age 
  filter(age < 200) %>%
  ggplot() +
  geom_freqpoly (mapping = aes(x=age, stat(density)), binwidth = 1)

# original plot
f+scale_x_continuous( breaks = seq(0,90,5))+
  scale_y_continuous(breaks = seq(0,.15,.02), labels = percent,
                     name="Percentage")

# zoomed-in plot
f+scale_x_continuous( breaks = seq(0,20,1))+
  scale_y_continuous(breaks = seq(0,.15,.02),labels = percent,
                     name="Percentage")+
  coord_cartesian(xlim = c(0, 20))

```

## Q3

`ICUSTAYS.csv` (<https://mimic.physionet.org/mimictables/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate graphs:  

- length of ICU stay  
- first ICU unit  
- gender  
- age  

**Solutions:**

Read data `ICUSTAY.csv`
```{r}
# Read the ICUSTAY data
Icustay <-read_csv('/home/203bdata/mimic-iii/ICUSTAYS.csv',
                 col_types = cols(ROW_ID=col_integer(),
                                  SUBJECT_ID = col_integer(),
                                  HADM_ID = col_integer(),
                                  ICUSTAY_ID = col_integer() ))

```

Length of ICU stay:

Most patients stayed in ICU less than 10 days
```{r}
f<- Icustay %>%
  # calculate the difference b/t in & out time
  mutate(Stayperiod = difftime(OUTTIME,INTIME, units = "days")) %>% 
  ggplot() +
  geom_freqpoly(mapping = aes(x=Stayperiod, stat(density)), binwidth = 1)

# original plot
f+scale_x_continuous( breaks = seq(0,175,10))+
  scale_y_continuous(breaks = seq(0,.3,.05), labels = percent
                     ,name="Percentage")

# zoomed-in plot
f + scale_x_continuous( breaks = seq(0,20,1))+
  scale_y_continuous(breaks = seq(0,.3,.05), labels = percent
                     ,name="Percentage")+
  coord_cartesian(xlim = c(0, 20))


```

First ICU unit:

MICU is the first ICU for most of patients(almost 35%), and the percentages for other ICUs are close and around 13%
```{r}
Icustay %>%
  ggplot() +
  geom_bar(mapping = aes(FIRST_CAREUNIT, y=..prop.., group=1),width = 0.75)+
  scale_y_continuous(labels = percent)+
  labs(x="First ICU Unit", y="Percentage")

```

Gender:

The gender distribution is the same as that for general patients. Male and female patients count 56% and 44% respectively. It is possible that most of the patients get into ICU.
```{r}
# c = Icustay %>% left_join(Patients, by='SUBJECT_ID')
Icustay %>%
  # join patient to get gender info, left join to keep all ICU data
  left_join(Patients, by='SUBJECT_ID') %>%
  
  # demographic info for unique patients
  distinct(SUBJECT_ID, .keep_all = TRUE) %>%
  
  # count male or female patients numbers
  group_by(GENDER) %>%
  summarise(count=n())%>%
  
  # calculate percentage for label
  mutate(Prop = count/sum(count)) %>%
  
  # fix the plotting order so I can make label in accordingly
  arrange(desc(GENDER)) %>%
  ggplot(aes(x = "", y= Prop, fill= GENDER)) + 
  geom_bar(width=1, stat = "identity",color = "white")+
  coord_polar(theta = 'y', direction = 1)+
  
  # add percentage labels on the pie charte
  geom_text(aes(y = cumsum(Prop) - 0.5*Prop,  # label position
            label = percent(Prop)), size=5)+ # label value and size

  
  # get rid of all the axis labels and ticks
  theme_void()+ 
  scale_x_discrete(breaks = NULL)+
  labs(x="",y="")+
  theme(axis.text.x=element_blank(),axis.text.y=element_blank())

  # ggplot() + 
  # geom_bar(mapping=aes(x='', fill=GENDER), width=.5) +
  # theme(axis.text.x=element_blank())+
  # coord_polar(theta = 'y', start=0)
  # # scale_x_discrete(breaks = NULL, name = '')
```

Age:

```{r}

f<- Icustay %>%
  left_join(Patients, by='SUBJECT_ID') %>%
  # calculate the difference b/t bod & admission time
  mutate(age = difftime(INTIME,DOB, units = "days")/365 ) %>% 
  # get rid of unrealistic age 
  filter(age < 200) %>%
  ggplot() +
  geom_freqpoly (mapping = aes(x=age, stat(density)), binwidth = 1)

# original plot
f+scale_x_continuous( breaks = seq(0,90,5))+
  scale_y_continuous(breaks = seq(0,.15,.02), labels = percent,
                     name="Percentage")

# zoomed-in plot
f+scale_x_continuous( breaks = seq(0,20,1))+
  scale_y_continuous(breaks = seq(0,.15,.02),labels = percent,
                     name="Percentage")+
  coord_cartesian(xlim = c(0, 20))


# c <- Icustay %>%
#   left_join(Patients, by='SUBJECT_ID') %>%
#   # calculate the difference b/t bod & admission time
#   mutate(age = as.numeric(as.duration(INTIME-DOB))/60/60/24/365 )
# 
# Icustay %>%
#   left_join(Patients, by='SUBJECT_ID') %>%
#   # calculate the difference b/t bod & admission time
#   mutate(age = as.numeric(as.duration(INTIME-DOB))/60/60/24/365 ) %>% 
#   ggplot() +
#   geom_histogram(mapping = aes(age))

```

## Q4

`CHARTEVENTS.csv` (<https://mimic.physionet.org/mimictables/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patient’s information is their electronic chart. The `ITEMID` variable indicates a single measurement type in the database. The `VALUE` variable is the value measured for `ITEMID`. 

`D_ITEMS.csv` (<https://mimic.physionet.org/mimictables/d_items/>) is the dictionary for the `ITEMID` in `CHARTEVENTS.csv`. Find potential values of `ITEMID` that correspond to systolic blood pressure, i.e., `LABEL` contains the string `systolic`. 

Compile a tibble that contains the first ICU stay of unique patients, with the patient's demographic information, the first systolic blood pressure measurement during ICU stay, and whether the patient died within 30 days of hospitcal admission.

** Solutions:**

Intepretion needed
```{r}
# Read the CHARTEVENTS data, which has non-default datetime format
ChartEvent <-read_csv('/home/203bdata/mimic-iii/CHARTEVENTS.csv',
      col_types = cols(ROW_ID = col_integer(),
                      SUBJECT_ID = col_integer(),
                      HADM_ID = col_integer(),
                      ICUSTAY_ID = col_integer(),
                      ITEMID = col_integer(),
                      CHARTTIME = col_datetime(format = "%m/%d/%y %H:%M"),
                      STORETIME = col_datetime(format = "%m/%d/%y %H:%M"),
                      CGID = col_integer()
                      ))
# Read D_ITEMS data
D_Items <-read_csv('/home/203bdata/mimic-iii/D_ITEMS.csv',
                 col_types = cols(ROW_ID = col_integer(),
                                  ITEMID = col_integer(),
                                  LABEL = col_character(),
                                  ABBREVIATION = col_character(),
                                  DBSOURCE = col_character(),
                                  LINKSTO = col_character(),
                                  CATEGORY = col_character(),
                                  UNITNAME = col_character(),
                                  PARAM_TYPE = col_character(),
                                  CONCEPTID = col_character() ))

# Filter to get the systolic items
SystolicItem <-D_Items %>% filter(str_detect(LABEL, 'systolic'))

# Get all the systolic measurement for patients in ICU
# Get the patient first systolic meas. with inner join and dinstict
# Arrange used to get the earliest measurement

# Get all the systolic measurement
SystolicMeas <- ChartEvent %>% 
  inner_join(SystolicItem, by = "ITEMID") 

# Get first ICU stay
FirstIcuStay <- arrange(Icustay, INTIME) %>%
  distinct(SUBJECT_ID, .keep_all = TRUE)

# Get all systolic measurement in first ICU stay by outjoin, and filter out the
# measurement did in ICU
# Only need measurement for ICU patients; Does every ICU patients
# had systolic measurement?  => no
FinalTibble <- inner_join(FirstIcuStay, SystolicMeas, by = "SUBJECT_ID") 


# %>%
#   right_join(Icustay, by = "SUBJECT_ID") %>%
#   arrange(CHARTTIME) %>%  
#   distinct(SUBJECT_ID, .keep_all = TRUE)

```
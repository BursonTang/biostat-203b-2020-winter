---
title: "Biostat 203B Homework 2"
author: Burson Tang UID#305068045
subtitle: Due Feb 7 @ 11:59PM
output: html_document
---

```{r setup, include=FALSE}
# Remember the result of previous run, it will save time.
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)   
```

<!-- # ```{r} -->
<!-- #  -->
<!-- # ``` -->

Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-III](https://mimic.physionet.org) data introduced in [homework 1](https://ucla-biostat203b-2020winter.github.io/hw/hw1/hw1.html).

## Q1

Demographic information of the patients admitted into hospital is available in `ADMISSION.csv`. See <https://mimic.physionet.org/mimictables/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs:   

  - admission year  
- admission month  
- admission week day  
- admission hour  
- length of hospital stay  
- admission type  
- number of admissions per patient  
- admission location  
- insurance  
- language  
- religion  
- martial status  
- ethnicity  
- death 

Note it is possible that one patient (uniquely identified by the `SUBJECT_ID`) is admitted into hospital multiple times. When summarizing some demographic information, it makes sense to summarize based on only unique patients. 

**Solution:**
Load packages and Data:
```{r} 
# load packages and check the data
library(tidyverse)
library(dplyr)
library(lubridate)
library(scales)

Admission <- read_csv('/home/203bdata/mimic-iii/ADMISSIONS.csv',
                 col_types = cols(ROW_ID=col_integer(),
                                  SUBJECT_ID = col_integer(),
                                  HADM_ID = col_integer(),
                                  ADMITTIME = col_datetime(format = ""),
                                  DISCHTIME = col_datetime(format = ""),
                                  DEATHTIME = col_datetime(format = ""),
                                  EDREGTIME = col_datetime(format = ""),
                                  EDOUTTIME = col_datetime(format = "")) )
```

Admission year
```{r}
Admission %>%
  mutate(adm_year = year(ADMITTIME)) %>%
  ggplot() +
  geom_freqpoly(mapping = aes(x=adm_year,stat(count)),binwidth = 1)+
  scale_x_continuous(breaks = seq(min(year(Admission$ADMITTIME),na.rm = TRUE),
                               max(year(Admission$ADMITTIME),na.rm = TRUE),5),
                     name = "Admission Year (encrypted)") +
  theme(axis.text.x = element_text(angle = 90))


```

Admission month
```{r}
# 
Admission %>%
  mutate(adm_month = month(ADMITTIME ,label=TRUE)) %>%
  ggplot() + geom_bar(mapping = aes(x=adm_month)) #+
  # scale_x_discrete(limits =seq(1,12,1))

# freqpoly
Admission %>%
  mutate(adm_month = month(ADMITTIME)) %>%
  ggplot() +  geom_freqpoly(mapping = aes(x=adm_month),binwidth = 1) +
  scale_x_continuous(breaks =seq(1,12,1))

# Make x ticks in MMM?
# Admission %>%
#   mutate(adm_month = month(ADMITTIME)) %>%  
#   ggplot() + 
#   geom_freqpoly(mapping = aes(x=adm_month),binwidth = 1) +
#   scale_x_date(month(Admission$ADMITTIME))
```

Admission week day
```{r}
Admission %>%
  mutate(adm_weekday = wday(ADMITTIME, label = TRUE)) %>% 
  ggplot() +
  geom_bar(mapping = aes(x=adm_weekday))
```

Admission hour
```{r}
Admission %>%
  mutate(adm_hr = hour(ADMITTIME)) %>% 
  ggplot() +
  geom_freqpoly(mapping = aes(x=adm_hr, stat(density)),binwidth = 1)
```

Length of hospital stay
```{r}
Admission %>%
  mutate(adm_StayTime = (DISCHTIME-ADMITTIME)/60/60) %>% 
  ggplot() +
  geom_freqpoly(mapping = aes(x=adm_StayTime, stat(density)),binwidth=1)
```

Admission type
```{r}
Admission %>%
  ggplot() +
  geom_bar(mapping = aes(x=ADMISSION_TYPE, y = ..prop.., group = 1))

```


Number of addmissions per patient
```{r}
# by_ID <- group_by(Admission,SUBJECT_ID)
# AdmCounts <- summarise(by_ID, count = n())
# AdmCounts %>%
#   ggplot() +
#   geom_freqpoly(mapping = aes(x=count, stat(density)), binwidth=1)+ 
#   scale_x_continuous(limits = c(0, 10), breaks = seq(0,10,1),
#                      name = 'Adm Times per Patient')

# Use pipe only
Admission %>% 
  group_by(SUBJECT_ID) %>%
  summarise(count = n()) %>%
  ggplot() +
  geom_freqpoly(mapping = aes(x=count, stat(density)), binwidth=1)+ 
  scale_x_continuous( breaks = seq(0,42,2),
                     name = 'Adm Times per Patient')
```

Admission Location
```{r}
Admission %>%
  ggplot() +
  geom_bar(mapping = aes(stringr::str_wrap(ADMISSION_LOCATION,15), y = ..prop.., group = 1) , width=.5) + 
  coord_flip() +
  labs(x = 'Admission Location', y = 'Percentage')

```

*NOTE*: Variables below are uniquely identified by patient/SUBJECTID. Define a variable `by-ID` with unique SUBJECT_ID.
```{r}
by_ID <- distinct(Admission, SUBJECT_ID, .keep_all = TRUE)
```

Insurance:
```{r}
by_ID %>%
  ggplot() + 
  geom_bar(mapping=aes(INSURANCE, y = ..prop.., group = 1))+
  labs(x='Insurance Types', y='Percentage')
```

Language
```{r}
by_ID %>%
  ggplot() + 
  geom_bar(mapping=aes(x=factor(1), fill=LANGUAGE))+
  coord_polar("y")
  # coord_flip()+
  # labs(x='Language', y='Percentage')

# Remove nan values?
by_ID %>%
  filter(!is.na(LANGUAGE)) %>%
  ggplot() + 
  geom_bar(mapping=aes(x=factor(1), fill=LANGUAGE))+
  coord_polar("y")

# bar chart?
by_ID %>%
  filter(!is.na(LANGUAGE)) %>%  
  ggplot() + 
  geom_bar(mapping=aes(LANGUAGE))+
  coord_flip()+
  labs(x='Language', y='Percentage')
```

Religion:
```{r}
by_ID %>%
  ggplot() + 
  geom_bar(mapping=aes(RELIGION, y = ..prop.., group = 1))+
  labs(x='Religion', y='Percentage')+
  coord_flip()
```

Martial Status:
```{r}
by_ID %>%
  ggplot() + 
  geom_bar(mapping=aes(MARITAL_STATUS, y = ..prop.., group = 1))+
  labs(x='Maritial Status', y='Percentage')+
  coord_flip()
```


Ethnicity:
```{r}
by_ID %>%
  ggplot() + 
  geom_bar(mapping=aes(stringr::str_wrap(ETHNICITY,10), y = ..prop.., group = 1))+
  labs(x='Maritial Status', y='Percentage')+
  coord_flip()
```

Death:
```{r}
# conditionaly mutate new variable: is.nan(death time) => livy;
# ! is.nan(death time) => dead.
# ifelse can do conditional mutating

by_ID %>%
  mutate(LifeStatus = ifelse(is.na(DEATHTIME), 'Live','Dead')) %>%
  ggplot() +
  geom_bar(mapping=aes(x = factor(1), fill= LifeStatus))+
  coord_polar(theta = 'y', direction = 1)+
  scale_x_discrete(breaks = NULL, name = '')
```


## Q2

Link the data in `ADMISSION.csv` and `PATIENTS.csv` (<https://mimic.physionet.org/mimictables/patients/>) and summarize following variables using appropriate graphs:  

- gender  
- age at admission 

**Solutions:**
Read data and join two tibble by `SUBJECT_ID`. Only `ADMISSION.csv` has duplicate keys
```{r}
# Read the PATIENTS data
Patients <-read_csv('/home/203bdata/mimic-iii/PATIENTS.csv',
                 col_types = cols(ROW_ID=col_integer(),
                                  SUBJECT_ID = col_integer(),
                                  GENDER = col_character(),
                                  DOB = col_datetime(format = ""),
                                  DOD = col_datetime(format = ""),
                                  DOD_HOSP = col_character(),
                                  DOD_SSN = col_datetime(format = ""),
                                  EXPIRE_FLAG = col_integer() ))

# join two datasets  => Only Admission has duplicate data
JointT <- left_join(Admission, Patients, by = "SUBJECT_ID")
```

Gender:
```{r}
JointT %>%
  ggplot() + 
  geom_bar(mapping=aes(x=factor(1), fill=GENDER), width=1)+
  coord_polar(theta = 'y', direction = 1)+
  scale_x_discrete(breaks = NULL, name = '')
  
```

Admission Age
```{r}
JointT %>%
  # calculate the difference b/t bod & admission time
  mutate(age = (ADMITTIME-DOB)/60/60/24/365 ) %>% 
  ggplot() +
  geom_histogram(mapping = aes(x=age), binwidth = 10)

```

## Q3

`ICUSTAYS.csv` (<https://mimic.physionet.org/mimictables/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate graphs:  

- length of ICU stay  
- first ICU unit  
- gender  
- age  

**Solutions:**
Read data `ICUSTAY.csv`
```{r}
# Read the ICUSTAY data
Icustay <-read_csv('/home/203bdata/mimic-iii/ICUSTAYS.csv',
                 col_types = cols(ROW_ID=col_integer(),
                                  SUBJECT_ID = col_integer(),
                                  HADM_ID = col_integer(),
                                  ICUSTAY_ID = col_integer() ))

```

Length of ICU stay
```{r}
Icustay %>%
  # calculate the difference b/t in & out time
  mutate(Stayperiod = (OUTTIME-INTIME)/60/60/24 ) %>% 
  ggplot() +
  geom_histogram(mapping = aes(x=Stayperiod, stat(density)), binwidth = 1)

```

First ICU unit
```{r}
Icustay %>%
  ggplot() +
  geom_bar(mapping = aes(FIRST_CAREUNIT, y=..prop.., group=1))

```

Gender:
```{r}
# c = Icustay %>% left_join(Patients, by='SUBJECT_ID')
Icustay %>%
  left_join(Patients, by='SUBJECT_ID') %>%
  ggplot() + 
  geom_bar(mapping=aes(x='', fill=GENDER), width=.5) +
  theme(axis.text.x=element_blank())+
  coord_polar(theta = 'y', start=0)
  # scale_x_discrete(breaks = NULL, name = '')
  
```

 Age
```{r}
c <- Icustay %>%
  left_join(Patients, by='SUBJECT_ID') %>%
  # calculate the difference b/t bod & admission time
  mutate(age = as.numeric(as.duration(INTIME-DOB))/60/60/24/365 )

Icustay %>%
  left_join(Patients, by='SUBJECT_ID') %>%
  # calculate the difference b/t bod & admission time
  mutate(age = as.numeric(as.duration(INTIME-DOB))/60/60/24/365 ) %>% 
  ggplot() +
  geom_histogram(mapping = aes(age))

```

## Q4

`CHARTEVENTS.csv` (<https://mimic.physionet.org/mimictables/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patientâ€™s information is their electronic chart. The `ITEMID` variable indicates a single measurement type in the database. The `VALUE` variable is the value measured for `ITEMID`. 

`D_ITEMS.csv` (<https://mimic.physionet.org/mimictables/d_items/>) is the dictionary for the `ITEMID` in `CHARTEVENTS.csv`. Find potential values of `ITEMID` that correspond to systolic blood pressure, i.e., `LABEL` contains the string `systolic`. 

Compile a tibble that contains the first ICU stay of unique patients, with the patient's demographic information, the first systolic blood pressure measurement during ICU stay, and whether the patient died within 30 days of hospitcal admission.

** Solutions:**
```{r}
# Read the CHARTEVENTS data, which has non-default datetime format
ChartEvent <-read_csv('/home/203bdata/mimic-iii/CHARTEVENTS.csv',
      col_types = cols(ROW_ID = col_integer(),
                      SUBJECT_ID = col_integer(),
                      HADM_ID = col_integer(),
                      ICUSTAY_ID = col_integer(),
                      ITEMID = col_integer(),
                      CHARTTIME = col_datetime(format = "%m/%d/%y %H:%M"),
                      STORETIME = col_datetime(format = "%m/%d/%y %H:%M"),
                      CGID = col_integer()
                      ))
# Read D_ITEMS data
D_Items <-read_csv('/home/203bdata/mimic-iii/D_ITEMS.csv',
                 col_types = cols(ROW_ID = col_integer(),
                                  ITEMID = col_integer(),
                                  LABEL = col_character(),
                                  ABBREVIATION = col_character(),
                                  DBSOURCE = col_character(),
                                  LINKSTO = col_character(),
                                  CATEGORY = col_character(),
                                  UNITNAME = col_character(),
                                  PARAM_TYPE = col_character(),
                                  CONCEPTID = col_character() ))

# Filter to get the systolic items
SystolicItem <-D_Items %>% filter(str_detect(LABEL, 'systolic'))

# Get all the systolic measurement for patients in ICU
# Get the patient first systolic meas. with inner join and dinstict
# Arrange used to get the earliest measurement

# Get all the systolic measurement
SystolicMeas <- ChartEvent %>% 
  inner_join(SystolicItem, by = "ITEMID") 

# Get first ICU stay
FirstIcuStay <- arrange(Icustay, INTIME) %>%
  distinct(SUBJECT_ID, .keep_all = TRUE)

# Get all systolic measurement in first ICU stay by outjoin, and filter out the
# measurement did in ICU
# Only need measurement for ICU patients; Does every ICU patients
# had systolic measurement?  => no
FinalTibble <- inner_join(FirstIcuStay, SystolicMeas, by = "SUBJECT_ID") %>%
  filter(CHARTTIME>INTIME & CHARTTIME<OUTTIME | is.na(CHARTTIME))


# %>%
#   right_join(Icustay, by = "SUBJECT_ID") %>%
#   arrange(CHARTTIME) %>%  
#   distinct(SUBJECT_ID, .keep_all = TRUE)

```